# ChatMemory MCP Server

一个用于 CherryStudio 的对话记忆管理服务器，基于 Model Context Protocol (MCP) 实现。

## 功能特性

- ✅ 保存和管理对话会话（Sessions）
- ✅ 全文检索（SQLite FTS5，支持中英文混合搜索）
- ✅ 会话总结（使用 Claude API，支持 brief/detailed 两种风格）
- ✅ 上下文注入（生成结构化的记忆注入块）
- ✅ 标签和元数据管理
- ✅ 跨会话聚合和去重

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置环境变量

创建数据库目录并设置环境变量：

```bash
# 创建数据库目录
mkdir -p ~/.chememcp

# 设置环境变量
export MEMORY_DB_PATH="$HOME/.chememcp/memory.db"
export ANTHROPIC_API_KEY="sk-ant-api03-xxx..."  # 可选，用于总结功能
```

### 3. 编译项目

```bash
npm run build
```

### 4. 运行服务器

```bash
# 直接运行
MEMORY_DB_PATH=./data/memory.db node build/index.js

# 或使用 npm script
npm start
```

## MCP 工具列表

### 1. `memory_save_session`
创建新的会话

**输入参数：**
- `title` (必需): 会话标题
- `tags` (可选): 标签数组
- `meta` (可选): 元数据对象

**示例：**
```json
{
  "title": "TCU 六统一架构设计讨论",
  "tags": ["TCU", "架构"],
  "meta": {"project": "TCU", "client": "某银行"}
}
```

### 2. `memory_save_messages`
保存消息到会话

**输入参数：**
- `session_id` (必需): 会话 ID
- `messages` (必需): 消息数组
  - `role`: 'user' | 'assistant' | 'system'
  - `content`: 消息内容
  - `created_at` (可选): 时间戳

### 3. `memory_list_sessions`
列出会话（支持分页和标签过滤）

**输入参数：**
- `limit` (默认: 20): 返回数量
- `offset` (默认: 0): 偏移量
- `tags` (可选): 标签过滤

### 4. `memory_get_session`
获取会话详情

**输入参数：**
- `session_id` (必需): 会话 ID
- `include_messages` (默认: true): 是否包含消息
- `message_limit` (默认: 100): 消息数量限制

### 5. `memory_search`
全文搜索消息

**输入参数：**
- `query` (必需): 搜索查询
- `top_k` (默认: 5): 返回结果数量
- `time_range_days` (默认: 180): 搜索时间范围（天）
- `tags` (可选): 标签过滤
- `session_id` (可选): 会话过滤

**示例：**
```json
{
  "query": "TCU 六统一",
  "top_k": 10,
  "time_range_days": 90
}
```

### 6. `memory_summarize_session`
生成会话总结

**输入参数：**
- `session_id` (必需): 会话 ID
- `style` (默认: 'brief'): 'brief' | 'detailed'
- `force_refresh` (默认: false): 强制重新生成

### 7. `memory_inject` ⭐ (核心功能)
生成记忆注入块

**输入参数（二选一）：**
- `session_id`: 单会话注入
- `query`: 跨会话聚合注入

**其他参数：**
- `style` (默认: 'brief'): 'brief' | 'detailed'
- `top_k` (默认: 5): 聚合结果数量（使用 query 时）

**输出格式：**
```
[MEMORY INJECTION]
主题：TCU 六统一架构设计

关键事实 Facts:
- 事实1
- 事实2

关键决策 Decisions:
- 决策1

下一步建议 Next Actions:
- 行动1

来源 Sources:
- session_id: xxx
- updated_at: 2026-02-03

[/MEMORY INJECTION]
```

## CherryStudio 集成

在 CherryStudio 的 MCP 配置中添加：

```json
{
  "mcpServers": {
    "chatmemory": {
      "command": "node",
      "args": ["/path/to/chememcp/build/index.js"],
      "env": {
        "MEMORY_DB_PATH": "/Users/username/.chememcp/memory.db",
        "ANTHROPIC_API_KEY": "sk-ant-api03-xxx..."
      }
    }
  }
}
```

## 开发

### 项目结构

```
chememcp/
├── src/
│   ├── index.ts              # MCP Server 主入口
│   ├── server.ts             # 工具注册
│   ├── database/             # 数据库层
│   │   ├── index.ts          # 数据库管理器
│   │   ├── schema.sql        # DDL 定义
│   │   ├── repository.ts     # 数据访问层
│   │   └── fts.ts            # FTS5 查询构建器
│   ├── tools/                # MCP 工具实现
│   ├── services/             # 业务服务
│   │   ├── summarizer.ts     # 总结服务
│   │   └── injector.ts       # 注入服务
│   ├── schemas/              # 类型和验证
│   └── utils/                # 工具函数
├── build/                    # 编译输出
└── data/                     # 数据存储
```

### 可用脚本

```bash
npm run build       # 编译项目
npm run watch       # 监听模式编译
npm run clean       # 清理编译输出
npm run type-check  # 类型检查（不编译）
npm start           # 运行服务器
```

## 技术栈

- **语言**: TypeScript 5.8+
- **运行时**: Node.js 18+
- **数据库**: SQLite 3 + FTS5
- **MCP SDK**: @modelcontextprotocol/sdk
- **LLM**: Anthropic Claude 3.5 Sonnet
- **验证**: Zod

## 注意事项

1. **环境变量**：`MEMORY_DB_PATH` 是必需的，`ANTHROPIC_API_KEY` 用于总结功能
2. **数据库路径**：请提前创建父目录
3. **API 成本**：总结功能会调用 Claude API（brief ~$0.002, detailed ~$0.005 每次）
4. **中文分词**：当前使用 SQLite FTS5 的 `unicode61` 分词器，对中文长词效果一般，后续可升级

## 故障排查

### 启动失败

```bash
# 检查环境变量
echo $MEMORY_DB_PATH
echo $ANTHROPIC_API_KEY

# 检查数据库目录是否存在
ls -la $(dirname $MEMORY_DB_PATH)

# 查看详细日志（输出到 stderr）
MEMORY_DB_PATH=./data/memory.db node build/index.js 2>&1 | less
```

### FTS5 搜索效果不佳

中文分词效果取决于 SQLite FTS5 的 `unicode61` tokenizer。如果需要更好的中文搜索，可以考虑：
- 使用更细粒度的查询（拆分关键词）
- 后续集成 jieba 分词
- 升级到向量检索

## 文档

- [SPECIFICATION.md](./SPECIFICATION.md) - 原始需求规格说明
- [.claude/plans/](/.claude/plans/) - 详细技术设计方案

## License

MIT

## 作者

Generated by Claude Code
